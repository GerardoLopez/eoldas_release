

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Inverting a time series of MODIS observations over agricultural fields &mdash; EOLDAS Users&#39; Guide 2012.06 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2012.06',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="EOLDAS Users&#39; Guide 2012.06 documentation" href="index.html" />
    <link rel="next" title="Spatial and multi-scale data assimilation examples" href="example_spatial.html" />
    <link rel="prev" title="A synthetic experiment: simulating the performance of Sentinel-2" href="example_sentinel2.html" /> 
  </head>
  <body>
      <div class="header">
        <a href="index.html">
          <img class="logo" src="_static/eoldas_logos.png" alt="Logo"/>
        </a>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="example_sentinel2.html">A synthetic experiment: simulating the performance of Sentinel-2</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="example_spatial.html">Spatial and multi-scale data assimilation examples</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="inverting-a-time-series-of-modis-observations-over-agricultural-fields">
<h1>Inverting a time series of MODIS observations over agricultural fields<a class="headerlink" href="#inverting-a-time-series-of-modis-observations-over-agricultural-fields" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The current example builds on the previous synthetic example by using
data from the MODIS sensor on the TERRA and AQUA platforms to invert
the state of the land surface over an agricultural area in Thuringia
(Germany). We shall use a script similar to <a class="reference external" href="https://github.com/jgomezdans/eoldas_release/blob/master/sentinel.py">sentinel.py</a>
but will use a slightly different inversion strategy. The data are in
the file <a class="reference external" href="https://github.com/jgomezdans/eoldas_release/blob/master/data/brdf_WW_1_A_1.kernelFiltered.dat">brdf_WW_1_A_1.kernelFiltered.dat</a></p>
<p>The solution strategy tries to overcome one of the weaknesses of the
system so far: the need for very costly cross-validation in order
to estimate the hyperparameters. This is done by using the single
observation estimates (assuming that they are a reasonable approximation
to the true estate) to initialise the EOLDAS inversion. Since the single
observation estimates are usually gappy, we interpolated them smoothly
using the regularisation method introduced in <a class="reference external" href="http://www.biomecardio.com/pageshtm/publi/csda10.pdf">Garcia (2010)</a>
This step is effectively a fast equivalent of the smoothing of NDVI
time series, that includes generalised cross validation. This results
in smooth time series of parameters, as well as estimates of the
regularisation hyperparameter (for each of the components of the state
vector). Starting the final EOLDAS inversion from here, using a value
of the hyperparameter derived from the smoothing puts the cost function
minimiser close to the minimum, so fewer iterations are needed to solve
the problem.</p>
</div>
<div class="section" id="the-script">
<h2>The script<a class="headerlink" href="#the-script" title="Permalink to this headline">¶</a></h2>
<p>The script is quite simple, and uses the <tt class="docutils literal"><span class="pre">Sentinel</span></tt> class from the
Sentinel synthetic experiment. The code is stored in a function
called <tt class="docutils literal"><span class="pre">main</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span> <span class="p">(</span><span class="n">ifile</span> <span class="o">=</span> <span class="s">&#39;data/brdf_WW_1_A_1.kernelFiltered.dat&#39;</span><span class="p">,</span> \
        <span class="n">confFile</span><span class="o">=</span><span class="s">&#39;config_files/sentinel_Def.conf&#39;</span><span class="p">,</span> \
        <span class="n">solve</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;xlai&#39;</span><span class="p">,</span><span class="s">&#39;xkab&#39;</span><span class="p">,</span><span class="s">&#39;scen&#39;</span><span class="p">,</span><span class="s">&#39;xkw&#39;</span><span class="p">,</span><span class="s">&#39;xkm&#39;</span><span class="p">,</span><span class="s">&#39;xleafn&#39;</span><span class="p">,</span><span class="s">&#39;xs1&#39;</span><span class="p">])</span> <span class="p">:</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Show that we can use this same setup to solve </span>
<span class="sd">  for the field data (MODIS) by using a different config file</span>
<span class="sd">  &#39;&#39;&#39;</span>
  
  
  <span class="n">ifile</span> <span class="o">=</span> <span class="s">&#39;data/brdf_WW_1_A_1.kernelFiltered.dat&#39;</span>
  <span class="n">ofileSingle</span> <span class="o">=</span> <span class="s">&#39;output/brdf_WW_1_A_1.kernelFilteredSingle.dat&#39;</span>
  <span class="n">ofile</span> <span class="o">=</span> <span class="s">&#39;output/brdf_WW_1_A_1.kernelFiltered.dat&#39;</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">Sentinel</span><span class="p">(</span><span class="n">solve</span><span class="o">=</span><span class="n">solve</span><span class="p">,</span><span class="n">confFile</span><span class="o">=</span><span class="n">confFile</span><span class="p">)</span>
  <span class="c"># as above, solve for initial estimate</span>
  <span class="n">s</span><span class="o">.</span><span class="n">solveSingle</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span><span class="n">ofileSingle</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">paramPlot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">ofileSingle</span><span class="p">),</span><span class="n">s</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">ofileSingle</span><span class="p">),</span>\
                 <span class="n">filename</span><span class="o">=</span><span class="s">&#39;plots/testFieldDataSingle.png&#39;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">ofileSingle</span><span class="p">,</span><span class="n">ofile</span><span class="o">=</span><span class="n">ofileSingle</span><span class="o">+</span><span class="s">&#39;_smooth&#39;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">paramPlot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="s">&#39;input/truth.dat&#39;</span><span class="p">),</span>\
              <span class="n">s</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">ofileSingle</span><span class="o">+</span><span class="s">&#39;_smooth&#39;</span><span class="p">),</span>\
              <span class="n">filename</span><span class="o">=</span><span class="s">&#39;plots/</span><span class="si">%s</span><span class="s">.png&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ofileSingle</span><span class="o">+</span><span class="s">&#39;_smooth&#39;</span><span class="p">))</span>

  <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gammaSolve</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wScale</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
  <span class="n">gamma</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gammaSolve</span><span class="p">[</span><span class="n">solve</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wScale</span><span class="p">[</span><span class="n">solve</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">solveRegular</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span><span class="n">ofile</span><span class="p">,</span><span class="n">modelOrder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> \
        <span class="n">initial</span><span class="o">=</span><span class="n">ofileSingle</span><span class="o">+</span><span class="s">&#39;_smooth&#39;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">paramPlot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">ofileSingle</span><span class="o">+</span><span class="s">&#39;_smooth&#39;</span><span class="p">),</span>\
              <span class="n">s</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">ofile</span> <span class="o">+</span> <span class="s">&#39;_result.dat&#39;</span><span class="p">),</span>\
              <span class="n">filename</span><span class="o">=</span><span class="s">&#39;plots/</span><span class="si">%s</span><span class="s">_Gamma</span><span class="si">%08d</span><span class="s">.png&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span><span class="n">gamma</span><span class="p">))</span>
</pre></div>
</div>
<p>The structure of the code will be familiar from the sentinel experiment:
the only novelty is the use of the <tt class="docutils literal"><span class="pre">Sentinel.smooth</span></tt> method to perform
the smoothing of the parameters. Instead of starting from the prior or
from the true data, as we did in the synthetic experiment, we use the
<tt class="docutils literal"><span class="pre">initial</span></tt> keyword to feed the smoothed interpolated estimates.
We can see that the result of the single observation inversions are
very noisy and with large uncertainties (file <tt class="docutils literal"><span class="pre">plots/testFieldDataSingle.png</span></tt>):</p>
<div class="figure">
<img alt="_images/testFieldDataSingle.png" src="_images/testFieldDataSingle.png" style="width: 80%;" />
<p class="caption">Results inverting each observation individually for a wheat field.
Note that this plot is in transformed coordinates</p>
</div>
<p>The parameter-by-parameter smoothing using the method of <a class="reference external" href="http://www.biomecardio.com/pageshtm/publi/csda10.pdf">Garcia (2010)</a>
results in a smoothed and complete version of the parameter evolution.
We can see that this is already a fairly good estimate of the parameters.
(the plot is in <tt class="docutils literal"><span class="pre">plots/output/brdf_WW_1_A_1.kernelFilteredSingle.dat_smooth.png</span></tt>)</p>
<div class="figure">
<img alt="_images/brdf_WW_1_A_1.kernelFilteredSingle.dat_smooth.png" src="_images/brdf_WW_1_A_1.kernelFilteredSingle.dat_smooth.png" style="width: 80%;" />
<p class="caption">Parameter-by-parameter smoothing and interpolation. The red line
shows the maximum a posteriori paremeter estimate, and the grey
lines show a measure of the uncertainty. The blue line show the
temporal evolution of the Sentinel synthetic experiment trajectories
for comparison. Note that this plot is in transformed coordinates</p>
</div>
<p>Using this a starting value, we then solve the EOLDAS problem. We expect
that this solution is already close the minimum, so solving the problem
will be reasonably fast. We also use the <span class="math">\(\Gamma\)</span> from the optimal
smoothing/interpolation. While this is not exactly the same problem that
we are solving in EOLDAS (different boundary conditions and limited
to a second order differntial operator), we assume that there&#8217;s tolerance
to <span class="math">\(\Gamma\)</span> (see Lewis et al 2012). The results confirm that we
only tweak the starting solution slightly: the red line (with associated
grey 95% CI) is very similar in most cases to the initial value (blue line).
The plot is in <tt class="docutils literal"><span class="pre">plots/output/brdf_WW_1_A_1.kernelFiltered.dat_Gamma00000529.png</span></tt>:</p>
<div class="figure">
<img alt="brdf_WW_1_A_1.kernelFiltered.dat_Gamma00000529.png:width:80%" src="brdf_WW_1_A_1.kernelFiltered.dat_Gamma00000529.png:width:80%" />
</div>
<div class="figure">
<img alt="_images/brdf_WW_1_A_1.kernelFiltered.dat_result.dat.plot.x.png" src="_images/brdf_WW_1_A_1.kernelFiltered.dat_result.dat.plot.x.png" style="width: 80%;" />
<p class="caption">DA solution in red (plus grey 95% credible interval) in real
coordinates . This plot can be found in
<tt class="docutils literal"><span class="pre">output/brdf_WW_1_A_1.kernelFiltered.dat_result.dat.plot.x.png</span></tt></p>
</div>
<p>The temporal evolution shown in this las plot is consistent with the
development of a wheat field, and even senescence and leaf water
dynamics can arguably be identified after the peak LAI period.</p>
</div>
<div class="section" id="some-comments">
<h2>Some comments<a class="headerlink" href="#some-comments" title="Permalink to this headline">¶</a></h2>
<p>This is nearly equivalent for solving for the dynamic model term. Since
the solution is already quite close to the minimum, only slight
modifications in the observation component are envisaged. Further
speed-ups can be envisaged by using a linear approximation to the
observation operator at this stage. Also, in a practical sense, the
single inversions don&#8217;t uncertainty calculations, and a faster first
pass using look-up tables might add further speed to the whole process.</p>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="example_sentinel2.html">A synthetic experiment: simulating the performance of Sentinel-2</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="example_spatial.html">Spatial and multi-scale data assimilation examples</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, P Lewis and J Gomez-Dans.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>